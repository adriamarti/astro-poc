---
import Layout from '../../layouts/Layout.astro';
import { sanity } from '../../lib/sanityClient';

export async function getStaticPaths() {
  const posts = await sanity.fetch(`*[_type == "post"]{ slug }`);
  return posts.map((post: any) => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;

const post = await sanity.fetch(`
  *[_type == "post" && slug.current == $slug][0]{
    title,
    mainImage {
      asset->{
        url
      }
    },
    body
  }
`, { slug });

if (!post) {
  throw new Error("Post not found");
}
---

<Layout>
  <main class="p-8 max-w-3xl mx-auto">
    <h1 class="text-4xl font-bold mb-6">{post.title}</h1>

    {post.mainImage?.asset?.url && (
      <img
        src={post.mainImage.asset.url}
        alt={post.title}
        class="w-full h-64 object-cover rounded-xl mb-6"
      />
    )}

    <article class="prose prose-lg max-w-none">
      {post.body?.map(block => {
        if (block._type === "block") {
          return (
            <p>
              {block.children?.map(child => child.text).join("")}
            </p>
          );
        }
        return null;
      })}
    </article>
  </main>
</Layout>
